
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if user is a super_admin
    function isSuperAdmin(userId) {
      return exists(/databases/$(database)/documents/users/$(userId)) &&
             get(/databases/$(database)/documents/users/$(userId)).data.basicInfo.userType == 'super_admin';
    }

    // Users can only read/write their own profile
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || isSuperAdmin(request.auth.uid);
      allow create: if request.auth.uid == userId;
    }
    
    match /events/{eventId} {
      allow read: if resource.data.status == 'approved' || 
                      request.auth.uid == resource.data.organizerId ||
                      isSuperAdmin(request.auth.uid);
                      
      allow create: if request.auth.uid == request.resource.data.organizerId;
      
      // Only the event organizer or an admin can update/delete
      allow update, delete: if request.auth.uid == resource.data.organizerId || isSuperAdmin(request.auth.uid);

      // Ticket tiers are part of an event
      match /ticketTiers/{tierId} {
        allow read: if true;
        allow create, update, delete: if request.auth.uid == get(/databases/$(database)/documents/events/$(eventId)).data.organizerId || isSuperAdmin(request.auth.uid);
      }
    }
    
    // Tickets
    match /tickets/{ticketId} {
      // User can only read their own tickets. Admin can read all.
      allow read: if request.auth.uid == resource.data.userId || isSuperAdmin(request.auth.uid);
      // Logged-in users can create tickets for themselves.
      allow create: if request.auth.uid == request.resource.data.userId;
      // Nobody can update a ticket directly once created, except maybe an admin.
      allow update: if isSuperAdmin(request.auth.uid);
    }
    
    // Payouts can only be read by the system/admin
    match /payouts/{payoutId} {
        allow read, write: if isSuperAdmin(request.auth.uid);
    }

    // Support tickets
    match /supportTickets/{ticketId} {
        allow create: if request.auth.uid == request.resource.data.userId;
        allow read, update: if isSuperAdmin(request.auth.uid);
    }

    // Transactions
    match /transactions/{transactionId} {
        allow create: if request.auth.uid != null;
        allow read: if isSuperAdmin(request.auth.uid);
    }
  }
}
